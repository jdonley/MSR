<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of loudspeaker_setup</title>
  <meta name="keywords" content="loudspeaker_setup">
  <meta name="description" content="">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">+Speaker_Setup</a> &gt; loudspeaker_setup.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for +Speaker_Setup&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>loudspeaker_setup
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong></strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>This is a script file. </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="loudspeaker_setup.html" class="code" title="">loudspeaker_setup</a>	</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="loudspeaker_setup.html" class="code" title="">loudspeaker_setup</a>	</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function obj = loudspeaker_setup(~)</a></li><li><a href="#_sub2" class="code">function obj = createEmptySoundfield(obj)</a></li><li><a href="#_sub3" class="code">function [width, height] = getFieldSize(obj)</a></li><li><a href="#_sub4" class="code">function obj = reproduceSoundfield(obj, Debug, Radius)</a></li><li><a href="#_sub5" class="code">function [S,H] = computeField(obj, xx, yy, freqs)</a></li><li><a href="#_sub6" class="code">function obj = calc_Loudspeaker_Weights(obj, Debug)</a></li><li><a href="#_sub7" class="code">function obj = calc_Loudspeaker_Locations(obj)</a></li><li><a href="#_sub8" class="code">function obj = calc_Loudspeaker_Directions(obj, directions)</a></li><li><a href="#_sub9" class="code">function obj = addMultizone_Soundfield(obj, multizone_soundfield )</a></li><li><a href="#_sub10" class="code">function obj = addLoudspeaker_Object(obj, loudspeaker_object)</a></li><li><a href="#_sub11" class="code">function obj = calcDesiredMask(obj)</a></li><li><a href="#_sub12" class="code">function f = getFrequency(obj)</a></li><li><a href="#_sub13" class="code">function obj = setWavenumberFromChild(obj)</a></li><li><a href="#_sub14" class="code">function obj = setRoomSize(obj, RoomSize)</a></li><li><a href="#_sub15" class="code">function obj = setRadius(obj, Radius)</a></li><li><a href="#_sub16" class="code">function obj = setLoudspeakerType(obj, Type)</a></li><li><a href="#_sub17" class="code">function obj = setLoudspeakerSpacing(obj, Speaker_Arr_Centre, LoudspeakerSpacing)</a></li><li><a href="#_sub18" class="code">function obj = save_Bright_Samples(obj)</a></li><li><a href="#_sub19" class="code">function obj = save_Quiet_Samples(obj)</a></li><li><a href="#_sub20" class="code">function [samples,locations,meansample] = getZoneSamples(obj, zone)</a></li><li><a href="#_sub21" class="code">function contrast = getAcoustic_Contrast(obj)</a></li><li><a href="#_sub22" class="code">function MSE = getBrightError(obj)</a></li><li><a href="#_sub23" class="code">function Atten_dB = getMaxPossibleAttenuation(obj)</a></li><li><a href="#_sub24" class="code">function [Sd, Sa] = getNormalisedFieldVectors(obj)</a></li><li><a href="#_sub25" class="code">function h = plotSoundfield(obj, field, colour, realistic, details)</a></li><li><a href="#_sub26" class="code">function zonePlots(obj, field, realistic, details)</a></li><li><a href="#_sub27" class="code">function plotCircle(obj, Origin, Centre, Radius, plotArgs)</a></li><li><a href="#_sub28" class="code">function plotRectangle(obj, Origin, Centre, Size, Angle, plotArgs)</a></li><li><a href="#_sub29" class="code">function detailPlots(obj, field, realistic, details)</a></li><li><a href="#_sub30" class="code">function drawPlaneWaveArrow(obj,startPt,endPt,PWangle,arrowSpecs)</a></li><li><a href="#_sub31" class="code">function addText2Arrow(obj,txt,startPt,endPt,fontsz,DistAway,AngAway)</a></li><li><a href="#_sub32" class="code">function drawAngle(obj,centre,startAng,endAng,Radius,LineWid,Elevation)</a></li><li><a href="#_sub33" class="code">function addText2Angle(obj,txt,centre,startAng,endAng,fontsz,DistAway,Elevation)</a></li><li><a href="#_sub34" class="code">function h = sourcePlots(obj, field, realistic, details)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 classdef <a href="loudspeaker_setup.html" class="code" title="">loudspeaker_setup</a>
0002     <span class="comment">% LOUDSPEAKER_SETUP - This class provides practical setup information</span>
0003     <span class="comment">%                     from a compatible desired multizone soundfield.</span>
0004     <span class="comment">%</span>
0005     <span class="comment">%</span>
0006     <span class="comment">%   Author: Jacob Donley, University of Wollongong, Australia</span>
0007     <span class="comment">%   Email: Jacob.Donley089@uowmail.edu.au</span>
0008     <span class="comment">%</span>
0009     
0010     properties
0011         <span class="comment">% Settings</span>
0012         res = 50;                           <span class="comment">% samples per metre %Resolution of soundfield</span>
0013         Dimensionality = 2;                 <span class="comment">% 2D, 2.5D, 3D</span>
0014         Loudspeaker_Count = 32;             <span class="comment">% Number of speakers used in the reproduction (Number of speakers required = ceil( Angular_Window * (2*M + 1) / (2*pi) ) ).</span>
0015         Origin = [0,0];                     <span class="comment">% [y,x]</span>
0016         RoomSize = [];
0017         Radius = 1.5;                       <span class="comment">% Radius of speaker layout</span>
0018         Speaker_Arc_Angle = 180;            <span class="comment">% Angle of the arc of speakers (360 = full circle, 180 = semi-circle)</span>
0019         Angle_FirstSpeaker = 0;             <span class="comment">% The angle where the first speaker of the array occurs</span>
0020         Speaker_Array_Centre = 180;         <span class="comment">% Angle of the centre of the loudspeaker arc</span>
0021         Speaker_Array_Length = 0;           <span class="comment">% Length of array (inclusive of end points)</span>
0022         Speaker_Spacing = 0.01;             <span class="comment">% The spacing between each consecutive loudspeaker</span>
0023         Speaker_Array_Type = <span class="string">'circle'</span>;      <span class="comment">% 'circle' or 'line' or 'coprime'</span>
0024         ExtendedField = false;
0025         Loudspeaker_Dimensions;
0026         Loudspeaker_Type = <span class="string">'Genelec 8010A'</span>; <span class="comment">% 'Genelec 8010A' or 'Genelec 8020C' or 'Meyer MM-4XP' or 'Parametric'</span>
0027         Loudspeaker_Object = [];
0028         <span class="comment">%         DipoleDistance = 343/12/1000; % a distance of [343m/s / (12 x 1kHz)] will give approximately equal magnitude on one side of dipole array at 1kHz</span>
0029         DipoleDistance = 343/(2*pi*2000);   <span class="comment">% Follows formula in Donley et al, &quot;Active Speech Control using Wave-Domain Processing with a Linear Wall of Dipole Secondary Sources&quot;, ICASSP, IEEE, 2017.</span>
0030         k_global = 2000 /343*2*pi;          <span class="comment">% Frequency in wavenumber</span>
0031         c = 343;
0032         Multizone_Soundfield;               <span class="comment">% multizone_soundfield object for reproduction</span>
0033         <span class="comment">%N_zone_samples = 1;                % The number of samples in each zone</span>
0034         <span class="comment">%Sampling_method = 'Centre';        % The layout of the samples in the zones. ('Centre', 'Random', 'Square', 'Circlular', 'All')</span>
0035         
0036         <span class="comment">% Results</span>
0037         <span class="comment">% 3D</span>
0038         Loudspeaker_Weights = [];
0039         Loudspeaker_Locations = [];
0040         Loudspeaker_Directions = [];
0041         Soundfield_reproduced = [];         <span class="comment">% The complex values of the reproduced sound field that is produced from this class.</span>
0042         Soundfield_virtual = [];            <span class="comment">% The complete virtual source soundfield</span>
0043         Desired_Mask = [];
0044         <span class="comment">%         Soundfield_Error = [];         % The error in the bright</span>
0045         <span class="comment">%         field</span>
0046         <span class="comment">% 2D</span>
0047         <span class="comment">%         Sound_sample_Avg = [];  %The average sound wave across the bright field in the direction of the desired planewave propagation</span>
0048         <span class="comment">%         Binaural_sample = [];   %TODO: Create binaural sample</span>
0049         <span class="comment">% 1D</span>
0050         <span class="comment">%         MSE_Bright_Field = 0;</span>
0051         <span class="comment">%         Err_dB_Bright_Field = 0;</span>
0052         <span class="comment">%         MSE_Quiet_Field = 0;</span>
0053         <span class="comment">%         Err_dB_Quiet_Field = 0;</span>
0054         <span class="comment">%         Acoustic_Brightness_Contrast = 0;</span>
0055         <span class="comment">%         Acoustic_Brightness_Contrast_dB = 0;</span>
0056         Bright_Samples = [];
0057         Bright_Samples_Locations = [];
0058         Quiet_Samples  = [];
0059         Quiet_Samples_Locations = [];
0060         Bright_Sample = 0;
0061         Quiet_Sample  = 0;
0062         
0063         Acoustic_Contrast = 0;
0064         MSE_Bright = 0;
0065         Attenuation_dB = 0; <span class="comment">%Log-normal mean and std error</span>
0066     <span class="keyword">end</span>
0067     
0068     properties (Access = private)
0069         
0070     <span class="keyword">end</span>
0071     
0072     <span class="comment">%% Contructor</span>
0073     methods
0074         <a name="_sub0" href="#_subfunctions" class="code">function obj = loudspeaker_setup(~)</a>
0075             
0076         <span class="keyword">end</span>
0077     <span class="keyword">end</span>
0078     
0079     <span class="comment">%% Private Methods</span>
0080     methods (Access = private)
0081         
0082         <a name="_sub1" href="#_subfunctions" class="code">function obj = createEmptySoundfield(obj)</a>
0083             [width, height] = obj.getFieldSize();
0084             obj.Soundfield_reproduced = zeros(height,width);
0085         <span class="keyword">end</span>
0086         
0087         <a name="_sub2" href="#_subfunctions" class="code">function [width, height] = getFieldSize(obj)</a>
0088             thisRadius = obj.Radius;
0089             <span class="keyword">if</span> obj.Loudspeaker_Count == 1
0090                 thisRadius = 0;
0091             <span class="keyword">end</span>
0092             <span class="keyword">if</span> isempty(obj.RoomSize)
0093                 R = max([thisRadius, obj.Multizone_Soundfield.Radius]);
0094             <span class="keyword">end</span>
0095             <span class="keyword">if</span> obj.ExtendedField &amp;&amp; isempty(obj.RoomSize)
0096                 <span class="keyword">if</span> ~isempty(strfind(obj.Speaker_Array_Type,<span class="string">'line'</span>)) <span class="comment">% Mirror accross linear array instead</span>
0097                     L = obj.Loudspeaker_Count;
0098                     <span class="keyword">if</span> strcmpi(obj.Speaker_Array_Type, <span class="string">'2line'</span>)
0099                         L = L/2;
0100                     <span class="keyword">end</span>
0101                     R = max([thisRadius, obj.Multizone_Soundfield.Radius]);                    
0102 <span class="comment">%                     R = max([R, (obj.Loudspeaker_Dimensions(1)*L)/2]);</span>
0103                     width = int16(obj.res * 2*R * 2*1.25);
0104                     height = int16(obj.res * R * 2*1.5);
0105                 <span class="keyword">else</span>
0106                     width = int16(obj.res * 3*R * 2);
0107                     height = width;
0108                 <span class="keyword">end</span>
0109             <span class="keyword">elseif</span> isempty(obj.RoomSize)
0110                 width = int16(obj.res * R * 2);
0111                 height = width;
0112             <span class="keyword">else</span>
0113                 height = int16(obj.RoomSize(1)*obj.res);
0114                 width  = int16(obj.RoomSize(2)*obj.res);
0115             <span class="keyword">end</span>
0116         <span class="keyword">end</span>
0117         
0118     <span class="keyword">end</span>
0119     
0120     <span class="comment">%% Public Methods</span>
0121     methods
0122         
0123         <span class="comment">%%%%%%%%%%%%%%%%%%  Main Soundfield Creation Function  %%%%%%%%%%%%%%%%%%%%</span>
0124         
0125         <a name="_sub3" href="#_subfunctions" class="code">function obj = reproduceSoundfield(obj, Debug, Radius)</a>
0126             <span class="comment">%  if ~strcmp(Debug, 'SAMPLES_ONLY')</span>
0127             <span class="keyword">if</span> nargin &lt; 2
0128                 obj = obj.setRadius(obj.Radius);
0129                 Debug = <span class="string">''</span>;
0130             <span class="keyword">elseif</span> nargin &lt; 3 || isempty(Radius)
0131                 obj = obj.setRadius(obj.Radius);
0132             <span class="keyword">else</span>
0133                 obj = obj.setRadius(Radius);
0134             <span class="keyword">end</span>
0135             
0136             obj = obj.setWavenumberFromChild();
0137             
0138             obj = obj.createEmptySoundfield;
0139             
0140             obj = obj.save_Bright_Samples();
0141             obj = obj.save_Quiet_Samples();
0142             
0143             <span class="keyword">if</span> ~strcmp(Debug, <span class="string">'SAMPLES_ONLY'</span>)
0144                 
0145                 O = size(obj.Soundfield_reproduced) / 2; <span class="comment">%Set the centre of the zone for indexing</span>
0146                 x = ((1:O(2)*2) - O(2)) / obj.res - obj.Origin(2);
0147                 y = ((1:O(1)*2) - O(1)) / obj.res - obj.Origin(1);
0148                 [xx,yy] = meshgrid(x,y);
0149                 
0150                 obj.Soundfield_reproduced = obj.computeField(xx,yy);
0151                 
0152             <span class="keyword">end</span>
0153             
0154             <span class="comment">% Equalise frequency dependent decay</span>
0155             T = abs(besselh(0, obj.k_global)); <span class="comment">% Magnitude compensation</span>
0156             obj.Loudspeaker_Weights = obj.Loudspeaker_Weights .* T; <span class="comment">%Remove effect of frequency dependent decay (2D ATF compensation?)</span>
0157             
0158             <span class="comment">% Normalise to the maximum of the absolute bright zone values</span>
0159             bMask = obj.Multizone_Soundfield.Bright_Zone.Soundfield_d_mean_mask;
0160             BrightSamples = obj.Bright_Samples;
0161             BrightSamples(isnan(BrightSamples))=0;
0162             maxBrightVal = mean(abs(BrightSamples(bMask(:)))); <span class="comment">% Changed to find the average as our goal is to have the bright zone fit on average.</span>
0163             <span class="comment">% Normalise phase about desired bright zone centre</span>
0164             <span class="comment">%             O = floor(size(obj.Bright_Samples)/2);</span>
0165             <span class="comment">%             centBrightAngle = angle(obj.Bright_Samples(O(1),O(2))) ...</span>
0166             <span class="comment">%                 -angle(obj.Multizone_Soundfield.Bright_Zone.Soundfield_d(O(1),O(2)));</span>
0167             <span class="comment">%             spkrAngleNorm = angle(obj.Loudspeaker_Weights(ceil(end/2)));%Normalise to centre of loudspeaker array</span>
0168             <span class="comment">%             adjAngle = 0;%spkrAngleNorm;% + centBrightAngle;</span>
0169             
0170             <span class="comment">% Normalise and align phase to bright zone</span>
0171             obj.Loudspeaker_Weights     = obj.Loudspeaker_Weights   / maxBrightVal;<span class="comment">% * exp(-1i*adjAngle); %Added to keep speaker weights tied with their response</span>
0172             obj.Soundfield_reproduced   = obj.Soundfield_reproduced / maxBrightVal;<span class="comment">% * exp(-1i*adjAngle);</span>
0173             obj.Bright_Samples          = obj.Bright_Samples        / maxBrightVal;<span class="comment">% * exp(-1i*adjAngle);</span>
0174             obj.Quiet_Samples           = obj.Quiet_Samples         / maxBrightVal;<span class="comment">% * exp(-1i*adjAngle);</span>
0175             obj.Bright_Sample           = obj.Bright_Sample         / maxBrightVal;
0176             obj.Quiet_Sample            = obj.Quiet_Sample          / maxBrightVal;
0177             
0178             <span class="comment">% Compute measures</span>
0179             obj.Acoustic_Contrast = obj.getAcoustic_Contrast();
0180             obj.MSE_Bright = obj.getBrightError();
0181             obj.Attenuation_dB = obj.getMaxPossibleAttenuation();
0182         <span class="keyword">end</span>
0183         
0184         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0185         <a name="_sub4" href="#_subfunctions" class="code">function [S,H] = computeField(obj, xx, yy, freqs)</a>
0186             <span class="keyword">if</span> nargin &lt; 4
0187                 freqs=[];
0188             <span class="keyword">end</span>
0189             th2 = obj.Loudspeaker_Locations(:,1);
0190             r2 = obj.Loudspeaker_Locations(:,2) ;
0191             L = obj.Loudspeaker_Weights;
0192             di = obj.Loudspeaker_Directions/pi*180;
0193             xwid = size(xx,2);
0194             ywid = size(xx,1);
0195             Nspkrs = obj.Loudspeaker_Count;
0196             [th1,r1] = cart2pol(xx,yy);
0197             
0198             <span class="comment">% Create matrices</span>
0199             r1_  = repmat(r1 ,1,1,Nspkrs);
0200             th1_ = repmat(th1,1,1,Nspkrs);
0201             xx_  = repmat(xx ,1,1,Nspkrs);
0202             yy_  = repmat(yy ,1,1,Nspkrs);
0203             r2_  = permute( repmat(r2     ,1,ywid,xwid), [2 3 1] );
0204             th2_ = permute( repmat(th2    ,1,ywid,xwid), [2 3 1] );
0205             L_   = permute( repmat(conj(L),1,ywid,xwid), [2 3 1] );
0206             Di   = permute( repmat(di     ,1,ywid,xwid), [2 3 1] );
0207             
0208             th_ = th1_-th2_;
0209             r = (r1_.^2 + r2_.^2 - 2*r1_.*r2_.*cos(th_)).^(1/2);
0210             [Lxx,Lyy] = pol2cart(th2_,r2_);
0211             th1 = atan2( yy_-Lyy, xx_-Lxx );
0212             
0213             <span class="comment">% Loudspeaker transfer functions</span>
0214             <span class="keyword">if</span> strcmp(obj.Loudspeaker_Type, <span class="string">'Parametric'</span>)
0215                 H = obj.Loudspeaker_Object.convolutionalModel( th1, r, Di, freqs);
0216             <span class="keyword">else</span>
0217                 <span class="keyword">if</span> obj.Dimensionality == 2
0218                     H = 1i/4 * besselh(0, obj.k_global * r ); <span class="comment">% 2D</span>
0219                 <span class="keyword">elseif</span> obj.Dimensionality == 3
0220                     <span class="comment">% H = 1i/4 * sqrt(pi./(2*obj.k_global * r)) .* besselh(0 + 0.5, obj.k_global * r ); % 3D</span>
0221                     <span class="comment">% H = exp( -1i*obj.k_global*r ) ./ (4*pi*r); % 3D</span>
0222                     H = exp( 1i*obj.k_global*r ) ./ (4*pi*r); <span class="comment">% 3D</span>
0223                 <span class="keyword">end</span>
0224             <span class="keyword">end</span>
0225             
0226             <span class="keyword">if</span> (ndims(L_) == ndims(H)) &amp;&amp; all(size(L_) == size(H))
0227                 S = sum( L_.*H , 3 );
0228             <span class="keyword">else</span>
0229                 S=[];
0230             <span class="keyword">end</span>
0231         <span class="keyword">end</span>
0232         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0233         
0234         <span class="comment">%% Loudspeaker Functions</span>
0235         <a name="_sub5" href="#_subfunctions" class="code">function obj = calc_Loudspeaker_Weights(obj, Debug)</a>
0236             <span class="keyword">if</span> nargin &lt; 2
0237                 Debug = <span class="string">''</span>;
0238             <span class="keyword">end</span>
0239             
0240             <span class="keyword">if</span> isempty( obj.Loudspeaker_Locations )
0241                 error(<span class="string">'Please set the loudspeaker locations first.'</span>) ;
0242             <span class="keyword">end</span>
0243             
0244             obj = obj.setWavenumberFromChild();
0245             
0246             Q0 = obj.Loudspeaker_Count;
0247             
0248             <span class="keyword">if</span>  Q0 &gt; 1
0249                 phi = obj.Speaker_Arc_Angle / 180 * pi;
0250                 <span class="keyword">if</span> strcmpi(obj.Speaker_Array_Type, <span class="string">'2line'</span>)
0251                     Q0_ = Q0/2;
0252                 <span class="keyword">else</span>
0253                     Q0_ = Q0;
0254                 <span class="keyword">end</span>
0255                 delta_phi_s = phi / Q0_;
0256                 M = obj.Multizone_Soundfield.getGlobalModeLimit;
0257                 N = obj.Multizone_Soundfield.N;
0258                 
0259                 phi_p = permute(repmat(obj.Multizone_Soundfield.F_angles(:).',Q0,1,2*M+1),[1 3 2]);
0260                 P_j = permute(repmat(obj.Multizone_Soundfield.P(:).',Q0,1,2*M+1),[1 3 2]);
0261                 k=obj.k_global;
0262                 m_ = repmat(-M:M,Q0,1,N);
0263                 m=m_(:,:,1);
0264                 phi_q = repmat(obj.Loudspeaker_Locations(:,1),1,2*M+1) + pi;
0265                 R_q = repmat(obj.Loudspeaker_Locations(:,2),1,2*M+1);
0266                 
0267                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0268                 <span class="keyword">if</span> obj.Dimensionality == 2                    
0269                     <span class="comment">% 2D</span>
0270                     ATF = besselh(m, k * R_q ); <span class="comment">% 2D</span>
0271                 <span class="keyword">elseif</span> obj.Dimensionality == 3
0272                     <span class="comment">% 3D</span>
0273                     ATF = sqrt(pi./(2*k*R_q)) .* besselh(m + 0.5, k * R_q ); <span class="comment">% 3D</span>
0274                 <span class="keyword">end</span>
0275                 
0276                 <span class="comment">% Expansion</span>
0277                 obj.Loudspeaker_Weights = sum(2 * exp(1i*m.*phi_q) * delta_phi_s .*   sum( P_j .* 1i.^m_ .* exp( -1i * m_ .* phi_p ),3) <span class="keyword">...</span>
0278                     ./ (1i*pi* ATF )  ,2).';
0279                 
0280                 <span class="comment">%                 A=sum( P_j .* 1i.^m_ .* exp( -1i * m_ .* phi_p ),3);A=A(1,:);</span>
0281                 <span class="comment">%                 m=(-M:M);</span>
0282                 <span class="comment">%                 phi_p=obj.Multizone_Soundfield.F_angles(:);</span>
0283                 <span class="comment">%                 P_j = obj.Multizone_Soundfield.P(:);</span>
0284                 <span class="comment">%                 phi_q=obj.Loudspeaker_Locations(:,1)+pi;</span>
0285                 <span class="comment">%                 R_q = obj.Loudspeaker_Locations(:,2);</span>
0286                 <span class="comment">%</span>
0287                 <span class="comment">%                 B = 2 * exp(1i*phi_q*m) * delta_phi_s;</span>
0288                 <span class="comment">%                 C =  P_j.' * exp( -1i * phi_p * m ) .* 1i.^m ;</span>
0289                 <span class="comment">%                 D = (1i*pi*besselh(repmat(m,Q0,1), k * repmat(R_q,1,2*M+1)));</span>
0290                 <span class="comment">%                 Z = B .* kron(C,ones(Q0,1)) ./ D;</span>
0291                 <span class="comment">%                 obj.Loudspeaker_Weights = sum(2 * exp(1i*m.*phi_q) * delta_phi_s .* C   ...</span>
0292                 <span class="comment">%                                                 ./ (1i*pi*besselh(m, k * R_q))  ,2).';</span>
0293                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0294                 
0295             <span class="keyword">else</span>
0296                 obj.Loudspeaker_Weights = 1;
0297             <span class="keyword">end</span>
0298             
0299             obj.Loudspeaker_Weights = obj.Loudspeaker_Weights' ;
0300             
0301             <span class="keyword">if</span> strcmpi(obj.Speaker_Array_Type, <span class="string">'2line'</span>) <span class="comment">%this is a dipole setup (infinitesimal spacing)</span>
0302                 <span class="comment">% Here we perform a delay and sum beamforming opperation to</span>
0303                 <span class="comment">% create better dipole directivity for the '2line' case</span>
0304                 d = obj.DipoleDistance;
0305                 f = obj.getFrequency;
0306                 Q = obj.Loudspeaker_Count;
0307                 LW= obj.Loudspeaker_Weights;
0308                 dpF = exp(-1i*pi/2) * <span class="keyword">...</span>
0309                     [exp( 1i*pi), <span class="keyword">...</span>
0310                     exp( 1i*pi*2*d*f/obj.c)];
0311                 dpFs = reshape(repmat(dpF,Q/2,1),[],1);
0312                 LW(1:end/2) = LW(end:-1:end/2+1);
0313                 obj.Loudspeaker_Weights = LW .* dpFs;
0314             <span class="keyword">end</span>
0315             
0316         <span class="keyword">end</span>
0317         
0318         
0319         <a name="_sub6" href="#_subfunctions" class="code">function obj = calc_Loudspeaker_Locations(obj)</a>
0320             Q0 = obj.Loudspeaker_Count;
0321             Rl = obj.Radius;
0322             
0323             <span class="keyword">if</span> strcmpi(obj.Speaker_Array_Type, <span class="string">'circle'</span>)
0324                 phi = obj.Speaker_Arc_Angle / 180 * pi;
0325                 delta_phi_s = phi / Q0;
0326                 first_spkr_offset = obj.Angle_FirstSpeaker / 180 * pi;
0327                 phi_q = ((1:Q0) - 1) * delta_phi_s + pi + first_spkr_offset;
0328                 Rl_ = repmat(Rl, length(phi_q), 1);
0329                 obj.Loudspeaker_Locations = [(phi_q(:) - pi) Rl_];
0330                 
0331             <span class="keyword">elseif</span> strcmpi(obj.Speaker_Array_Type, <span class="string">'line'</span>)
0332                 wid = obj.Loudspeaker_Dimensions(1);
0333                 space = obj.Speaker_Spacing;
0334                 centre = obj.Speaker_Array_Centre;
0335                 L = obj.Loudspeaker_Count;
0336                 len = (wid+space)*L - space;
0337                 x = repmat(obj.Radius, 1, L);
0338                 
0339                 <span class="keyword">if</span> L == 1
0340                     a2first = obj.Angle_FirstSpeaker/180*pi;
0341                     a2center = centre/180*pi;
0342                     spkr_rho = x(1) / cos(a2first - a2center);
0343                     obj.Loudspeaker_Locations = [a2first spkr_rho];
0344                 <span class="keyword">else</span>
0345                     
0346                     <span class="keyword">if</span> ~mod(L,2)
0347                         <span class="comment">%                         y = ((wid+space)/2):(wid+space):len/2;</span>
0348                         y = (1/2:L/2)*(wid+space);
0349                         y = [flip(-y), y];
0350                     <span class="keyword">else</span>
0351                         y = (1:(L-1)/2)*(wid+space);
0352                         y = [flip(-y), 0, y];
0353                     <span class="keyword">end</span>
0354                     
0355                     [spkr_theta, spkr_rho]=cart2pol(x,y);
0356                     spkr_theta = spkr_theta + centre/180*pi;
0357                     
0358                     obj.Loudspeaker_Locations = [spkr_theta(:), spkr_rho(:)];
0359                     
0360                     obj.Angle_FirstSpeaker = obj.Loudspeaker_Locations(1,1) / pi * 180;
0361                     obj.Speaker_Arc_Angle = obj.Loudspeaker_Locations(<span class="keyword">end</span>,1) / pi * 180 - obj.Angle_FirstSpeaker;
0362                     
0363                     LLends = obj.Loudspeaker_Locations([1 end],:);
0364                     [LLx,LLy] = pol2cart(LLends(:,1),LLends(:,2));
0365                     obj.Speaker_Array_Length = sum(diff([LLx, LLy]).^2).^0.5; <span class="comment">% inclusive of end points</span>
0366                 <span class="keyword">end</span>
0367                 
0368             <span class="keyword">elseif</span> strcmpi(obj.Speaker_Array_Type, <span class="string">'2line'</span>) <span class="comment">%this is a dipole setup (infinitesimal spacing)</span>
0369                 
0370                 wid = obj.Loudspeaker_Dimensions(1);
0371                 dist_=obj.DipoleDistance;
0372                 space = obj.Speaker_Spacing;
0373                 centre = obj.Speaker_Array_Centre;
0374                 Ltot = obj.Loudspeaker_Count;
0375                 <span class="keyword">if</span> mod(Ltot,2)
0376                     error(<span class="string">'Not an even number of loudspeakers. ''2line'' array type requires an even number.'</span>);
0377                 <span class="keyword">end</span>
0378                 L = Ltot/2;
0379                 len = (wid+space)*L - space;
0380                 x = [repmat(obj.Radius+dist_/2, 1, L), <span class="keyword">...</span>
0381                     repmat(obj.Radius-dist_/2, 1, L)];
0382                 
0383                 <span class="keyword">if</span> L == 1
0384                     a2first = obj.Angle_FirstSpeaker/180*pi;
0385                     a2center = centre/180*pi;
0386                     spkr_rho = x(1) / cos(a2first - a2center);
0387                     obj.Loudspeaker_Locations = [a2first spkr_rho];
0388                 <span class="keyword">else</span>
0389                     
0390                     y = ((wid+space)/2):(wid+space):len/2;
0391                     y = [flip(-y), y];
0392                     
0393                     y = [y, flip(y)];
0394                     
0395                     [spkr_theta, spkr_rho]=cart2pol(x,y);
0396                     spkr_theta = spkr_theta + centre/180*pi;
0397                     
0398                     obj.Loudspeaker_Locations = [spkr_theta(:), spkr_rho(:)];
0399                     
0400                     [AngFir,~] = cart2pol(mean(x([1 end])),y(1));
0401                     [AngLas,~] = cart2pol(mean(x(end/2 + [1 -1])),y(end/2));
0402                     
0403                     obj.Angle_FirstSpeaker = AngFir/pi*180 + centre;
0404                     obj.Speaker_Arc_Angle = AngLas/pi*180 + centre - obj.Angle_FirstSpeaker;
0405                     
0406                     obj.Speaker_Array_Length = sum(abs(y([1 end/2]))); <span class="comment">% inclusive of end points</span>
0407                 <span class="keyword">end</span>
0408                 
0409             <span class="keyword">elseif</span> strcmpi(obj.Speaker_Array_Type, <span class="string">'coprime'</span>)
0410                 L = obj.Loudspeaker_Count;
0411                 
0412                 <span class="keyword">if</span> ~isprime(L+1) &amp;&amp; ~isprime(L)
0413                     error(<span class="string">'Number of loudspeakers is not one less than a prime number.'</span>);
0414                 <span class="keyword">end</span>
0415                 
0416                 wid = obj.Loudspeaker_Dimensions(1);
0417                 space = obj.Speaker_Spacing;
0418                 centre = obj.Speaker_Array_Centre;
0419                 len = (wid+space)*L - space;
0420                 x = repmat(obj.Radius, L, 1);
0421                 
0422                 ends_ = (len/2-wid/2);
0423                 y1 =  linspace(ends_,-ends_,L/2+1);
0424                 y1(end) = [];
0425                 y2 =  linspace(ends_,-ends_,L/2+2);
0426                 y_ = -y2(1);
0427                 y2(1)=[];
0428                 y2(end)=[];
0429                 
0430                 y = [y1; y2];
0431                 <span class="keyword">if</span> iseven(L)
0432                     y = y(:);
0433                 <span class="keyword">else</span>
0434                     y = [y(:);y_];
0435                 <span class="keyword">end</span>
0436                 
0437                 [spkr_theta, spkr_rho]=cart2pol(x,y);
0438                 spkr_theta = spkr_theta + centre/180*pi;
0439                 
0440                 obj.Loudspeaker_Locations = [spkr_theta(:), spkr_rho(:)];
0441                 
0442                 obj.Angle_FirstSpeaker = obj.Loudspeaker_Locations(1,1) / pi * 180;
0443                 obj.Speaker_Arc_Angle = obj.Loudspeaker_Locations(<span class="keyword">end</span>,1) / pi * 180 - obj.Angle_FirstSpeaker;
0444                 
0445             <span class="keyword">end</span>
0446             
0447             <span class="comment">% Determine the directions of the loudspeakers depending on the</span>
0448             <span class="comment">% type of array and the position of the speakers in that array.</span>
0449             obj = obj.calc_Loudspeaker_Directions();
0450             
0451         <span class="keyword">end</span>
0452         
0453         
0454         <a name="_sub7" href="#_subfunctions" class="code">function obj = calc_Loudspeaker_Directions(obj, directions)</a>
0455             <span class="keyword">if</span> nargin &gt;= 2
0456                 obj.Loudspeaker_Directions = directions;
0457             <span class="keyword">else</span>
0458                 Q0 = obj.Loudspeaker_Count;
0459                 
0460                 <span class="keyword">if</span> strcmp(obj.Speaker_Array_Type, <span class="string">'circle'</span>)
0461                     obj.Loudspeaker_Directions = obj.Loudspeaker_Locations(:,1) - pi;
0462                     
0463                 <span class="keyword">elseif</span> strcmp(obj.Speaker_Array_Type, <span class="string">'line'</span>) <span class="keyword">...</span>
0464                         || strcmp(obj.Speaker_Array_Type, <span class="string">'coprime'</span>)
0465                     obj.Loudspeaker_Directions = ones(Q0,1) * (obj.Speaker_Array_Centre - 180) / 180 * pi;
0466                     
0467                 <span class="keyword">end</span>
0468             <span class="keyword">end</span>
0469         <span class="keyword">end</span>
0470         
0471         <span class="comment">%% Auxilary Methods</span>
0472         <a name="_sub8" href="#_subfunctions" class="code">function obj = addMultizone_Soundfield(obj, multizone_soundfield )</a>
0473             
0474             obj.Multizone_Soundfield = [];
0475             
0476             <span class="keyword">if</span> length(obj.Multizone_Soundfield) &lt; 1
0477                 obj.res      = multizone_soundfield.res;
0478             <span class="keyword">elseif</span> obj.res ~= multizone_soundfield.res
0479                 error([<span class="string">'A multizone soundfield does not match the sampling resolution of the previously added soundfield(s).'</span> <span class="keyword">...</span>
0480                     <span class="string">'\n Previous Soundfield Resolution = %0.2d samples/m'</span> <span class="keyword">...</span>
0481                     <span class="string">'\n New Soundfield Resolution = %0.2d samples/m'</span>], <span class="keyword">...</span>
0482                     obj.res, multizone_soundfield.res);
0483             <span class="keyword">end</span>
0484             
0485             obj.Multizone_Soundfield = multizone_soundfield;
0486             
0487             obj.k_global = obj.Multizone_Soundfield.k_global;
0488             obj = obj.setRadius(obj.Multizone_Soundfield.Radius);
0489             
0490         <span class="keyword">end</span>
0491         
0492         <a name="_sub9" href="#_subfunctions" class="code">function obj = addLoudspeaker_Object(obj, loudspeaker_object)</a>
0493             obj.Loudspeaker_Object  = loudspeaker_object;
0494             obj.Loudspeaker_Object.res = obj.res;
0495             obj = obj.createEmptySoundfield;
0496             obj.Loudspeaker_Object.field_size = size(obj.Soundfield_reproduced) / obj.res;
0497             <span class="keyword">if</span> isfield(obj.Loudspeaker_Object,<span class="string">'set_fd'</span>)
0498                 obj.Loudspeaker_Object = obj.Loudspeaker_Object.set_fd(obj.k_global*obj.c/2/pi);
0499             <span class="keyword">end</span>
0500         <span class="keyword">end</span>
0501         
0502         <a name="_sub10" href="#_subfunctions" class="code">function obj = calcDesiredMask(obj)</a>
0503             <span class="comment">%             [w,h] = obj.getFieldSize();</span>
0504             <span class="comment">%             x = linspace(-obj.Radius, obj.Radius , w);</span>
0505             <span class="comment">%             y = linspace(-obj.Radius, obj.Radius , h);</span>
0506             <span class="comment">%             [xx,yy] = meshgrid(xyvec,xyvec);</span>
0507             [O(2), O(1)] = obj.getFieldSize(); <span class="comment">%Set the centre of the zone for indexing</span>
0508             O = double(O)/2;
0509             x = ((1:O(2)*2) - O(2)) / obj.res - obj.Origin(2);
0510             y = ((1:O(1)*2) - O(1)) / obj.res - obj.Origin(1);
0511             [xx,yy] = meshgrid(x,y);
0512             obj.Desired_Mask = xx.^2 + yy.^2 &lt;= (obj.Multizone_Soundfield.Radius)^2 * ones(numel(y), numel(x));
0513         <span class="keyword">end</span>
0514         
0515         <a name="_sub11" href="#_subfunctions" class="code">function f = getFrequency(obj)</a>
0516             f = obj.k_global * obj.c / (2 * pi);
0517         <span class="keyword">end</span>
0518         
0519         <a name="_sub12" href="#_subfunctions" class="code">function obj = setWavenumberFromChild(obj)</a>
0520             obj.k_global = obj.Multizone_Soundfield.k_global;
0521             <span class="keyword">if</span> ~isempty(obj.Loudspeaker_Object) &amp;&amp; isfield(obj.Loudspeaker_Object,<span class="string">'set_fd'</span>)
0522                 obj.Loudspeaker_Object = obj.Loudspeaker_Object.set_fd(obj.k_global*obj.c/2/pi);
0523             <span class="keyword">end</span>
0524         <span class="keyword">end</span>
0525         
0526         <a name="_sub13" href="#_subfunctions" class="code">function obj = setRoomSize(obj, RoomSize)</a>
0527             obj.RoomSize = RoomSize;
0528         <span class="keyword">end</span>
0529         
0530         <a name="_sub14" href="#_subfunctions" class="code">function obj = setRadius(obj, Radius)</a>
0531             obj.Radius = Radius;
0532             obj = obj.calcDesiredMask();
0533         <span class="keyword">end</span>
0534         
0535         
0536         <a name="_sub15" href="#_subfunctions" class="code">function obj = setLoudspeakerType(obj, Type)</a>
0537             obj.Loudspeaker_Type = Type;
0538             
0539             <span class="comment">% Dimensions: [width, depth, height]</span>
0540             <span class="keyword">if</span> strcmp(Type, <span class="string">'Genelec 8010A'</span>)
0541                 obj.Loudspeaker_Dimensions = [0.121, 0.116, 0.195]; <span class="comment">%Genelec 8010A</span>
0542                 
0543             <span class="keyword">elseif</span> strcmp(Type, <span class="string">'Genelec 8020C'</span>)
0544                 obj.Loudspeaker_Dimensions = [0.151, 0.142, 0.242]; <span class="comment">%Genelec 8020C</span>
0545                 
0546             <span class="keyword">elseif</span> strcmp(Type, <span class="string">'Meyer MM-4XP'</span>)
0547                 obj.Loudspeaker_Dimensions = [0.103, 0.145, 0.103]; <span class="comment">%Meyer MM-4XP</span>
0548                 
0549             <span class="keyword">elseif</span> strcmp(Type, <span class="string">'Parametric'</span>)
0550                 obj.Loudspeaker_Dimensions = obj.Loudspeaker_Object.Spkr_Dimensions; <span class="comment">%Parametric Array Loudspeaker (PAL) Dimensions</span>
0551                 
0552             <span class="keyword">else</span>
0553                 error(<span class="string">'Loudspeaker type not supported.'</span>);
0554             <span class="keyword">end</span>
0555         <span class="keyword">end</span>
0556         
0557         <a name="_sub16" href="#_subfunctions" class="code">function obj = setLoudspeakerSpacing(obj, Speaker_Arr_Centre, LoudspeakerSpacing)</a>
0558             width = obj.Loudspeaker_Dimensions(1);
0559             <span class="keyword">if</span> nargin &lt; 2
0560                 centre = obj.Speaker_Array_Centre;
0561             <span class="keyword">else</span>
0562                 centre = Speaker_Arr_Centre;
0563             <span class="keyword">end</span>
0564             <span class="keyword">if</span> nargin &lt; 3
0565                 space = obj.Speaker_Spacing;
0566             <span class="keyword">else</span>
0567                 space = LoudspeakerSpacing;
0568             <span class="keyword">end</span>
0569             
0570             circumf = obj.Loudspeaker_Count * (space + width);
0571             
0572             new_Speaker_Arc_Angle = circumf / obj.Radius * 180/pi;
0573             <span class="keyword">if</span> new_Speaker_Arc_Angle &gt; obj.Speaker_Arc_Angle &amp;&amp; ~isnan(obj.Speaker_Arc_Angle)
0574                 wrnCol = [255,100,0]/255;
0575                 wrnTxt = [<span class="string">'The previously specified loudspeaker arc is too small to accommodate the desired number of loudspeakers.'</span> 10, <span class="keyword">...</span>
0576                     <span class="string">'Either:'</span> 10 <span class="keyword">...</span>
0577                     9    <span class="string">'1) Reduce the number of loudspeakers.'</span> 10 <span class="keyword">...</span>
0578                     9  <span class="string">'2) Use smaller loudspeakers.  or'</span> 10 <span class="keyword">...</span>
0579                     9  <span class="string">'3) Increase the size of the loudspeaker arc.'</span> 10, <span class="keyword">...</span>
0580                     <span class="string">'The loudspeaker arc will be adjusted now...'</span> 10, <span class="keyword">...</span>
0581                     9  <span class="string">'Old loudspeaker arc: ~'</span> num2str(round(obj.Speaker_Arc_Angle,1)) <span class="string">'°'</span> 10, <span class="keyword">...</span>
0582                     9  <span class="string">'New loudspeaker arc: ~'</span> num2str(round(new_Speaker_Arc_Angle,1)) <span class="string">'°'</span> 10 10];
0583                 cprintf(wrnCol, wrnTxt);
0584             <span class="keyword">end</span>
0585             obj.Speaker_Arc_Angle = new_Speaker_Arc_Angle;
0586             <span class="keyword">if</span> obj.Loudspeaker_Count &gt; 1
0587                 obj.Angle_FirstSpeaker = centre - obj.Speaker_Arc_Angle/2 + (((space + width)/2) / obj.Radius * 180/pi );
0588             <span class="keyword">end</span>
0589         <span class="keyword">end</span>
0590         
0591         
0592         <a name="_sub17" href="#_subfunctions" class="code">function obj = save_Bright_Samples(obj)</a>
0593             [obj.Bright_Samples, <span class="keyword">...</span>
0594                 obj.Bright_Samples_Locations, <span class="keyword">...</span>
0595                 obj.Bright_Sample] <span class="keyword">...</span>
0596                 = <a href="#_sub20" class="code" title="subfunction [samples,locations,meansample] = getZoneSamples(obj, zone)">getZoneSamples</a>( obj, obj.Multizone_Soundfield.Bright_Zone );
0597         <span class="keyword">end</span>
0598         
0599         <a name="_sub18" href="#_subfunctions" class="code">function obj = save_Quiet_Samples(obj)</a>
0600             [obj.Quiet_Samples, <span class="keyword">...</span>
0601                 obj.Quiet_Samples_Locations, <span class="keyword">...</span>
0602                 obj.Quiet_Sample] <span class="keyword">...</span>
0603                 = <a href="#_sub20" class="code" title="subfunction [samples,locations,meansample] = getZoneSamples(obj, zone)">getZoneSamples</a>( obj, obj.Multizone_Soundfield.Quiet_Zone );
0604         <span class="keyword">end</span>
0605         
0606         <a name="_sub19" href="#_subfunctions" class="code">function [samples,locations,meansample] = getZoneSamples(obj, zone)</a>
0607             <span class="comment">% % If number is not a square number change method to random</span>
0608             <span class="comment">% if ~~rem(obj.N_zone_samples, sqrt(obj.N_zone_samples))</span>
0609             <span class="comment">% obj.Sampling_method = 'Random';</span>
0610             <span class="comment">% else</span>
0611             <span class="comment">%</span>
0612             <span class="comment">% end</span>
0613             <span class="comment">%</span>
0614             <span class="comment">% if strcmp(obj.Sampling_method, 'Random')</span>
0615             <span class="comment">%</span>
0616             <span class="comment">% end</span>
0617             
0618             O = zone.Radius_q * obj.res;
0619             znSz = zone.ZoneSize * obj.res;
0620             <span class="comment">%Oz = size(obj.Soundfield_reproduced) / 2 / obj.res; %Set the centre of the zone for indexing</span>
0621             
0622             y = (-znSz(1)/2+1:znSz(1)/2) / obj.res;
0623             x = (-znSz(2)/2+1:znSz(2)/2) / obj.res;
0624             mask = zone.Soundfield_d_mask;
0625             maskNaN = 1*mask;
0626             maskNaN(~mask)=nan;
0627             
0628             [xx,yy] = meshgrid(x,y);
0629             xx = (xx + zone.Origin_q.X ) .* maskNaN ;
0630             yy = (yy + zone.Origin_q.Y ) .* maskNaN;
0631             
0632             [locations(:,:,1), <span class="keyword">...</span>
0633                 locations(:,:,2)] = cart2pol(xx,yy);
0634             samples = obj.computeField(xx,yy);
0635             meansample = mean( abs( samples(mask) ) );
0636             
0637         <span class="keyword">end</span>
0638         
0639         <a name="_sub20" href="#_subfunctions" class="code">function contrast = getAcoustic_Contrast(obj)</a>
0640             bMask = obj.Multizone_Soundfield.Bright_Zone.Soundfield_d_mask;
0641             qMask = obj.Multizone_Soundfield.Quiet_Zone.Soundfield_d_mask;
0642             contrast = mean( abs( obj.Bright_Samples(bMask) ) .^ 2 ) / mean( abs( obj.Quiet_Samples(qMask) ) .^ 2 );
0643         <span class="keyword">end</span>
0644         
0645         <a name="_sub21" href="#_subfunctions" class="code">function MSE = getBrightError(obj)</a>
0646             
0647             [desired_vec, actual_vec] = obj.getNormalisedFieldVectors;
0648             MSE = sum( abs(desired_vec - actual_vec) .^ 2 ) / sum( abs(desired_vec) .^ 2 );
0649             
0650         <span class="keyword">end</span>
0651         
0652         <a name="_sub22" href="#_subfunctions" class="code">function Atten_dB = getMaxPossibleAttenuation(obj)</a>
0653             [desired_vec, actual_vec] = obj.getNormalisedFieldVectors;
0654             
0655             att = abs( desired_vec - actual_vec );
0656             dbConv = 20/log(10);
0657             m = mean(att.');
0658             v = var(att.');
0659             mu_ = log( m ./ sqrt( 1 + v./m.^2 ) ) *dbConv;
0660             sigm = sqrt( log( 1 + v./m.^2 ) ) *dbConv;
0661             
0662             Atten_dB = [mu_, sigm]; <span class="comment">%lognormal mean and std error</span>
0663         <span class="keyword">end</span>
0664         
0665         <a name="_sub23" href="#_subfunctions" class="code">function [Sd, Sa] = getNormalisedFieldVectors(obj)</a>
0666             zoneMask = obj.Multizone_Soundfield.Bright_Zone.Soundfield_d_mask;
0667             O = floor(size(zoneMask)/2);
0668             
0669             desired = obj.Multizone_Soundfield.Bright_Zone.Soundfield_d .* zoneMask;
0670             actual  = obj.Bright_Samples .* zoneMask;
0671             
0672             desired_vec=desired(zoneMask~=0);
0673             actual_vec=actual(zoneMask~=0);
0674             
0675             desired_adj = 1 / rms(abs(desired_vec)) .* exp(-1i* angle(desired(O(1),O(2))));
0676             actual_adj  = 1 / rms(abs(actual_vec)) .* exp(-1i* angle(actual(O(1),O(2))));
0677             
0678             Sd = desired_vec .* desired_adj;
0679             Sa = actual_vec .* actual_adj;
0680         <span class="keyword">end</span>
0681         
0682         <span class="comment">%% Plotting Functions</span>
0683         <a name="_sub24" href="#_subfunctions" class="code">function h = plotSoundfield(obj, field, colour, realistic, details)</a>
0684             <span class="keyword">if</span> nargin &lt; 5; details.DrawDetails = false; <span class="keyword">end</span>
0685             <span class="keyword">if</span> nargin &lt; 4; realistic = false; <span class="keyword">end</span>
0686             <span class="keyword">if</span> nargin &lt; 3; colour = <span class="string">'default'</span>; <span class="keyword">end</span>
0687             <span class="keyword">if</span> nargin &lt; 2; field = obj.Soundfield_reproduced; <span class="keyword">end</span>
0688             
0689             ZaxisSize = max(abs(real(field(~isinf(field(:))))));
0690             f = real(field) .* obj.Desired_Mask;
0691             <span class="keyword">if</span> min(real(f(:))) &lt; 0
0692                 CaxisSize = [-1 1].*ZaxisSize;
0693                 <span class="keyword">if</span> abs(min(real(f(:)))+pi) &lt; 1e-3
0694                     CaxisSize = CaxisSize./obj.res.*pi;
0695                 <span class="keyword">end</span>
0696             <span class="keyword">else</span>
0697                 field = mag2db(field);
0698                 <span class="comment">%fb = mag2db(abs(obj.Bright_Samples));</span>
0699                 <span class="comment">%fq = mag2db(abs(obj.Quiet_Samples));</span>
0700                 <span class="comment">%CaxisSize(1) = floor(min(fq(~isnan(fq))));</span>
0701                 <span class="comment">%CaxisSize(2) = ceil(max(fb(~isnan(fb))));</span>
0702                 CaxisSize(1) = floor(min(field(:)));
0703                 CaxisSize(2) = ceil(max(field(:)));
0704             <span class="keyword">end</span>
0705             
0706             <span class="keyword">if</span> ~details.DrawDetails
0707                 details.NTicks = [5 5];
0708             <span class="keyword">end</span>
0709             
0710             lenDim = size(field,2);
0711             XTick = fix(linspace(-1,1,details.NTicks(1))*lenDim/obj.res)*obj.res/2 + lenDim/2;
0712             XTickLabel = (XTick-lenDim/2)/obj.res-obj.Origin(2);
0713             XTickLabel = num2cell(XTickLabel);
0714             <span class="keyword">if</span> diff(details.NTicks)&lt;0
0715                 <span class="keyword">for</span> i=1:2:numel(XTickLabel)
0716                     XTickLabel{i}=[];
0717                 <span class="keyword">end</span>
0718             <span class="keyword">end</span>
0719             
0720             lenDim = size(field,1);
0721             YTick = fix(linspace(-1,1,details.NTicks(2))*lenDim/obj.res)/2*obj.res + lenDim/2;
0722             YTickLabel = (YTick-lenDim/2)/obj.res-obj.Origin(1);
0723             YTickLabel = num2cell(YTickLabel);
0724             
0725             ax = gca;
0726             h = surf(ax, real(field),<span class="string">'EdgeColor'</span>,<span class="string">'None'</span>);
0727             <span class="keyword">if</span> realistic
0728                 drawnow; pause(0.05);
0729                 h.FaceAlpha = 0.5;
0730             <span class="keyword">end</span>
0731             <span class="keyword">if</span> contains(colour,<span class="string">'scientific'</span>)
0732                 colormap(ax, cmap( strrep(colour,<span class="string">'scientific_'</span>,<span class="string">''</span>) ));
0733             <span class="keyword">else</span>
0734                 colormap(ax, colour);
0735             <span class="keyword">end</span>
0736             view(2);
0737             axis equal;
0738             box on;
0739             <span class="keyword">if</span> realistic
0740                 room = details.SYS.Room_Setup.Room_Size([2 1])*obj.res;
0741                 axis([(size(field,2)/2-room(1)/2) (size(field,2)/2+room(1)/2) (size(field,1)/2-room(2)/2) (size(field,1)/2+room(2)/2)]);
0742             <span class="keyword">else</span>
0743                 axis([0 size(field,2)+1 0 size(field,1)+1]);
0744             <span class="keyword">end</span>
0745             set(gca, <span class="string">'XTick'</span>, XTick); set(gca, <span class="string">'XTickLabel'</span>, XTickLabel);
0746             set(gca, <span class="string">'YTick'</span>, YTick); set(gca, <span class="string">'YTickLabel'</span>, YTickLabel);
0747             set(gca, <span class="string">'TickDir'</span>, <span class="string">'out'</span> );
0748             set(gca, <span class="string">'FontSize'</span>, 14);
0749             set(gca, <span class="string">'FontName'</span>, <span class="string">'cambria'</span>);
0750             <span class="comment">%Create Title</span>
0751             title(<span class="string">'Pressure Soundfield'</span>,<span class="keyword">...</span>
0752                 <span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="keyword">...</span>
0753                 <span class="string">'FontSize'</span>,16,<span class="keyword">...</span>
0754                 <span class="string">'FontName'</span>,<span class="string">'Times'</span>);
0755             <span class="comment">% Create xlabel</span>
0756             xlabel(<span class="string">'Width (m)'</span>,<span class="string">'FontSize'</span>,16,<span class="string">'FontName'</span>,<span class="string">'Times'</span>);
0757             <span class="comment">% Create ylabel</span>
0758             ylabel(<span class="string">'Length (m)'</span>,<span class="string">'FontSize'</span>,16,<span class="string">'FontName'</span>,<span class="string">'Times'</span>);
0759             <span class="comment">% Create zlabel</span>
0760             zlabel(<span class="string">'Amplitude'</span>,<span class="string">'Visible'</span>,<span class="string">'off'</span>);
0761             caxis(CaxisSize);
0762             
0763             hCB = colorbar;
0764             hCB.Ticks = interp1(1:length(caxis),caxis,linspace(1,length(caxis),5));
0765             <span class="keyword">if</span> sum(CaxisSize) == 0 &amp;&amp; abs(min(real(f(:)))+pi) &gt;= 1e-3
0766                 hCB.TickLabels = num2str(linspace(CaxisSize(1),CaxisSize(2),5)' ./ obj.res);
0767             <span class="keyword">else</span>
0768                 hCB.TickLabels = num2str(linspace(CaxisSize(1),CaxisSize(2),5)' );
0769             <span class="keyword">end</span>
0770             hCB.FontName = <span class="string">'Times'</span>;
0771             hCB.FontSize = 16;
0772             
0773             details.ZoneGeometry = obj.Multizone_Soundfield.Geometry;
0774             details.ReproRegionSize = obj.Multizone_Soundfield.ReproRegionSize;
0775             
0776             obj.zonePlots(real(field),realistic, details);
0777             obj.sourcePlots(real(field),realistic);
0778             <span class="keyword">if</span> details.DrawDetails
0779                 obj.detailPlots(real(field),realistic,details);
0780             <span class="keyword">end</span>
0781             
0782         <span class="keyword">end</span>
0783         
0784         <a name="_sub25" href="#_subfunctions" class="code">function zonePlots(obj, field, realistic, details)</a>
0785             <span class="keyword">if</span> nargin &lt; 4; details.DrawDetails = false; <span class="keyword">end</span>
0786             <span class="keyword">if</span> nargin &lt; 3; realistic = false; <span class="keyword">end</span>
0787             <span class="keyword">if</span> nargin &lt; 2; field = obj.Soundfield_reproduced; <span class="keyword">end</span>
0788             
0789             <span class="keyword">if</span> details.DrawDetails
0790                 LineWid = details.zoneLineWid;
0791             <span class="keyword">else</span>
0792                 LineWid = 1;
0793             <span class="keyword">end</span>
0794             
0795             <span class="comment">% For a Global Zone outline plot</span>
0796             GlobalZone_temp = obj.Multizone_Soundfield.Bright_Zone;
0797             GlobalZone_temp.Origin_q = struct(<span class="string">'X'</span>,0,<span class="string">'Y'</span>,0);
0798             GlobalZone_temp.Radius_q = obj.Multizone_Soundfield.Radius;
0799             GlobalZone_temp.ZoneGeometry = obj.Multizone_Soundfield.Geometry;
0800             GlobalZone_temp.ZoneSize = obj.Multizone_Soundfield.ReproRegionSize;
0801             
0802             <span class="keyword">if</span> realistic
0803                 maxZ = 0;
0804             <span class="keyword">else</span>
0805                 maxZ = max(real(field(:)));
0806             <span class="keyword">end</span>
0807             hold on
0808             th = 0:pi/obj.res:2*pi;
0809             SpatialZones = [obj.Multizone_Soundfield.Quiet_Zone <span class="keyword">...</span>
0810                 obj.Multizone_Soundfield.Bright_Zone <span class="keyword">...</span>
0811                 GlobalZone_temp ];
0812             linestyles = {<span class="string">'-'</span>;<span class="string">'-'</span>;<span class="string">'--'</span>}; <span class="comment">% {Quiet Zone, Bright Zone, Reproduction Region}</span>
0813             <span class="keyword">for</span> q = 1:length(SpatialZones)
0814                 O = [flip(size(field))/2 0] + [flip(obj.Origin)*obj.res 0];
0815                 CentreP=[SpatialZones(q).Origin_q.X, <span class="keyword">...</span>
0816                     SpatialZones(q).Origin_q.Y, maxZ];
0817                 <span class="keyword">if</span> contains( lower(SpatialZones(q).ZoneGeometry), <span class="string">'circle'</span> )
0818                     <a href="#_sub27" class="code" title="subfunction plotCircle(obj, Origin, Centre, Radius, plotArgs)">plotCircle</a>(obj, O, <span class="keyword">...</span>
0819                         CentreP, <span class="keyword">...</span>
0820                         SpatialZones(q).Radius_q, <span class="keyword">...</span>
0821                         {linestyles{q}, <span class="string">'Color'</span>, [0 0 0], <span class="string">'LineWidth'</span>, LineWid});
0822                 <span class="keyword">elseif</span> contains( lower(SpatialZones(q).ZoneGeometry), <span class="string">'rect'</span> )
0823                     <a href="#_sub28" class="code" title="subfunction plotRectangle(obj, Origin, Centre, Size, Angle, plotArgs)">plotRectangle</a>(obj, O, <span class="keyword">...</span>
0824                         CentreP, <span class="keyword">...</span>
0825                         SpatialZones(q).ZoneSize, <span class="keyword">...</span>
0826                         0, <span class="keyword">...</span><span class="comment"> Direction (angle of rotation)</span>
0827                         {linestyles{q}, <span class="string">'Color'</span>, [0 0 0], <span class="string">'LineWidth'</span>, LineWid});
0828                 <span class="keyword">end</span>
0829                 <span class="keyword">if</span> details.DrawDetails
0830                     xunit = LineWid*3*cos(th) + CentreP(1)*obj.res+O(1);
0831                     yunit = LineWid*3*sin(th) + CentreP(2)*obj.res+O(2);
0832                     patch(xunit, yunit, ones(length(xunit),1)*maxZ, [0 0 0], <span class="string">'LineStyle'</span>, <span class="string">'none'</span>);
0833                 <span class="keyword">end</span>
0834             <span class="keyword">end</span>
0835             
0836             hold off
0837         <span class="keyword">end</span>
0838         
0839         <a name="_sub26" href="#_subfunctions" class="code">function plotCircle(obj, Origin, Centre, Radius, plotArgs)</a>
0840             th = 0:pi/obj.res:2*pi; <span class="comment">%full circle</span>
0841             C(1) = Centre(1) * obj.res + Origin(1);
0842             C(2) = Centre(2) * obj.res + Origin(2);
0843             C(3) = Centre(3)           + Origin(3);
0844             R = Radius * obj.res;
0845             Xunits = R * cos(th) + C(1);
0846             Yunits = R * sin(th) + C(2);
0847             Zunits = Xunits*0 + C(3); <span class="comment">%planar circle plot</span>
0848             hold on;
0849             plot3(Xunits, Yunits, Zunits, plotArgs{:});
0850             hold off;
0851         <span class="keyword">end</span>
0852         
0853         <a name="_sub27" href="#_subfunctions" class="code">function plotRectangle(obj, Origin, Centre, Size, Angle, plotArgs)</a>
0854             C(1) = Centre(1) * obj.res + Origin(1);
0855             C(2) = Centre(2) * obj.res + Origin(2);
0856             C(3) = Centre(3)           + Origin(3);
0857             px_=[-1,1,1,-1;-1,1,1,-1];
0858             py_=[-1,-1,1,1;-1,-1,1,1];
0859             pz_=[-1,-1,-1,-1;1,1,1,1];
0860             Xunits = px_*Size(1)/2*obj.res + C(1);
0861             Yunits = py_*Size(2)/2*obj.res + C(2);
0862             Zunits = Xunits*0 + C(3); <span class="comment">%planar rectangle plot</span>
0863             hold on;
0864             plot3(Xunits([1:end 1]), Yunits([1:end 1]), Zunits([1:end 1]), plotArgs{:});
0865             hold off;
0866         <span class="keyword">end</span>
0867         
0868         <a name="_sub28" href="#_subfunctions" class="code">function detailPlots(obj, field, realistic, details)</a>
0869             <span class="keyword">if</span> nargin &lt; 4; details.DrawDetails = false; <span class="keyword">end</span>
0870             <span class="keyword">if</span> nargin &lt; 3; realistic = false; <span class="keyword">end</span>
0871             <span class="keyword">if</span> nargin &lt; 2; field = obj.Soundfield_reproduced; <span class="keyword">end</span>
0872             <span class="keyword">if</span> realistic
0873                 maxZ = 0;
0874             <span class="keyword">else</span>
0875                 maxZ = max(real(field(:)));
0876             <span class="keyword">end</span>
0877             hold on
0878             
0879             LineWid = details.arrowLineWid;
0880             arrowLen = details.arrowLength;
0881             arrowTipAng = details.arrowAngle;
0882             endBuf = details.arrowBuffer / obj.res;
0883             fontSZ = details.lblFontSize;
0884             
0885             <span class="comment">%Origin</span>
0886             O = [length(field) / 2; <span class="keyword">...</span>
0887                 length(field) / 2; <span class="keyword">...</span>
0888                 maxZ * obj.res];
0889             
0890             <span class="comment">% Zone Centres</span>
0891             [Bth,Br]=cart2pol(obj.Multizone_Soundfield.Bright_Zone.Origin_q.X, <span class="keyword">...</span>
0892                 obj.Multizone_Soundfield.Bright_Zone.Origin_q.Y);
0893             [Bx,By] = pol2cart(Bth,Br);
0894             [Bx_,By_] = pol2cart(Bth,Br-endBuf*2);
0895             BZ_Centre = [ Bx, By, 0]' * obj.res + O;
0896             BZ_Centre_ = [ Bx_, By_, 0]' * obj.res + O;
0897             
0898             [Qth,Qr]=cart2pol(obj.Multizone_Soundfield.Quiet_Zone.Origin_q.X, <span class="keyword">...</span>
0899                 obj.Multizone_Soundfield.Quiet_Zone.Origin_q.Y);
0900             [Qx,Qy] = pol2cart(Qth,Qr);
0901             [Qx_,Qy_] = pol2cart(Qth,Qr-endBuf*2);
0902             QZ_Centre = [ Qx, Qy, 0]' * obj.res + O;
0903             QZ_Centre_ = [ Qx_, Qy_, 0]' * obj.res + O;
0904             
0905             <span class="comment">% Zone Edges</span>
0906             BZ_Edge = [obj.Multizone_Soundfield.Bright_Zone.Origin_q.X; <span class="keyword">...</span>
0907                 obj.Multizone_Soundfield.Bright_Zone.Origin_q.Y + <span class="keyword">...</span>
0908                 (obj.Multizone_Soundfield.Bright_Zone.Radius_q-endBuf); <span class="keyword">...</span>
0909                 0]* obj.res + O;
0910             QZ_Edge = [obj.Multizone_Soundfield.Quiet_Zone.Origin_q.X; <span class="keyword">...</span>
0911                 obj.Multizone_Soundfield.Quiet_Zone.Origin_q.Y - <span class="keyword">...</span>
0912                 (obj.Multizone_Soundfield.Quiet_Zone.Radius_q-endBuf); <span class="keyword">...</span>
0913                 0]* obj.res + O;
0914             
0915             <span class="comment">%Reproduction Edge</span>
0916             Repro_Edge_Angle = -45;<span class="comment">%degrees</span>
0917             [Repro_Edge(1), <span class="keyword">...</span>
0918                 Repro_Edge(2), <span class="keyword">...</span>
0919                 Repro_Edge(3)] = sph2cart(Repro_Edge_Angle/180*pi,0,(obj.Multizone_Soundfield.Radius-endBuf)*obj.res);
0920             Repro_Edge = Repro_Edge' + O;
0921             
0922             <span class="comment">%Loudspeaker Arc</span>
0923             [SpkrArc_Edge(1), <span class="keyword">...</span>
0924                 SpkrArc_Edge(2), <span class="keyword">...</span>
0925                 SpkrArc_Edge(3)] = sph2cart(obj.Speaker_Array_Centre/180*pi,0,(obj.Radius-endBuf)*obj.res);
0926             SpkrArc_Edge = SpkrArc_Edge' + O;
0927             
0928             <span class="comment">% Plot detailed coordinates</span>
0929             arrowSpecs={<span class="string">'Length'</span>,arrowLen,<span class="string">'Width'</span>,LineWid,<span class="string">'TipAngle'</span>,arrowTipAng,<span class="string">'BaseAngle'</span>,(90+arrowTipAng)/2};
0930             arrow(O,BZ_Centre_,arrowSpecs{:});
0931             arrow(O,QZ_Centre_,arrowSpecs{:});
0932             arrow(BZ_Centre,BZ_Edge,arrowSpecs{:});
0933             arrow(QZ_Centre,QZ_Edge,arrowSpecs{:});
0934             arrow(O,Repro_Edge,arrowSpecs{:});
0935             arrow(O,SpkrArc_Edge,arrowSpecs{:});
0936             pwAngle=obj.Multizone_Soundfield.Bright_Zone.SourceOrigin.Angle;
0937             <a href="#_sub30" class="code" title="subfunction drawPlaneWaveArrow(obj,startPt,endPt,PWangle,arrowSpecs)">drawPlaneWaveArrow</a>(obj,BZ_Centre,BZ_Edge,pwAngle,arrowSpecs); <span class="comment">%planewave arrow</span>
0938             
0939             <span class="comment">% Label arrows</span>
0940             <a href="#_sub31" class="code" title="subfunction addText2Arrow(obj,txt,startPt,endPt,fontsz,DistAway,AngAway)">addText2Arrow</a>(obj,<span class="string">'\it{r_z}'</span>,O,BZ_Centre_,fontSZ, -10,0);
0941             <a href="#_sub31" class="code" title="subfunction addText2Arrow(obj,txt,startPt,endPt,fontsz,DistAway,AngAway)">addText2Arrow</a>(obj,<span class="string">'\it{r_z}'</span>,O,QZ_Centre_,fontSZ,-10,0);
0942             <a href="#_sub31" class="code" title="subfunction addText2Arrow(obj,txt,startPt,endPt,fontsz,DistAway,AngAway)">addText2Arrow</a>(obj,<span class="string">'\it{r}'</span>,BZ_Centre,BZ_Edge,fontSZ,10,0);
0943             <a href="#_sub31" class="code" title="subfunction addText2Arrow(obj,txt,startPt,endPt,fontsz,DistAway,AngAway)">addText2Arrow</a>(obj,<span class="string">'\it{r}'</span>,QZ_Centre,QZ_Edge,fontSZ,-10,0);
0944             <a href="#_sub31" class="code" title="subfunction addText2Arrow(obj,txt,startPt,endPt,fontsz,DistAway,AngAway)">addText2Arrow</a>(obj,<span class="string">'\it{R}'</span>,O,Repro_Edge,fontSZ,10,0);
0945             <a href="#_sub31" class="code" title="subfunction addText2Arrow(obj,txt,startPt,endPt,fontsz,DistAway,AngAway)">addText2Arrow</a>(obj,<span class="string">'\it{R_l}'</span>,O,SpkrArc_Edge,fontSZ,-10,0);
0946             
0947             <span class="comment">% Plot angles</span>
0948             R = obj.Multizone_Soundfield.Radius * obj.res *0.15;
0949             <a href="#_sub32" class="code" title="subfunction drawAngle(obj,centre,startAng,endAng,Radius,LineWid,Elevation)">drawAngle</a>(obj,O,Bth,obj.Speaker_Array_Centre/180*pi,R,LineWid,maxZ)
0950             <a href="#_sub33" class="code" title="subfunction addText2Angle(obj,txt,centre,startAng,endAng,fontsz,DistAway,Elevation)">addText2Angle</a>(obj,<span class="string">'\it{\phi}'</span>,O,Bth,obj.Speaker_Array_Centre/180*pi,fontSZ,R+5,maxZ)
0951             <a href="#_sub32" class="code" title="subfunction drawAngle(obj,centre,startAng,endAng,Radius,LineWid,Elevation)">drawAngle</a>(obj,O,Bth,Qth,R,LineWid,maxZ)
0952             <a href="#_sub33" class="code" title="subfunction addText2Angle(obj,txt,centre,startAng,endAng,fontsz,DistAway,Elevation)">addText2Angle</a>(obj,<span class="string">'\it{\pi}'</span>,O,Bth,Qth,fontSZ,R+5,maxZ)
0953             <a href="#_sub32" class="code" title="subfunction drawAngle(obj,centre,startAng,endAng,Radius,LineWid,Elevation)">drawAngle</a>(obj,BZ_Centre,pwAngle,-Bth,R,LineWid,maxZ)
0954             <a href="#_sub33" class="code" title="subfunction addText2Angle(obj,txt,centre,startAng,endAng,fontsz,DistAway,Elevation)">addText2Angle</a>(obj,<span class="string">'\it{\theta}'</span>,BZ_Centre,pwAngle,-Bth,fontSZ,R+5,maxZ)
0955             
0956             <span class="comment">% Auxilary components</span>
0957             <span class="comment">%Alias Point</span>
0958             Q = QZ_Centre;
0959             B = BZ_Centre;
0960             Rl = (obj.Radius);
0961             r1 = obj.Multizone_Soundfield.Bright_Zone.Radius_q;
0962             r2 = obj.Multizone_Soundfield.Quiet_Zone.Radius_q;
0963             L = obj.Loudspeaker_Count;
0964             phi_L=obj.Speaker_Arc_Angle/180*pi;
0965             Rprime = max([r1+Br,r2+Qr]);
0966             theta = pwAngle/180*pi;
0967             arrLen = obj.Speaker_Array_Length;
0968             k = obj.k_global;
0969             Bv = B-O;
0970             Qv = Q-O;
0971             
0972             rotMat_90 = [cos(pi/2) -sin(pi/2) 0;<span class="keyword">...</span>
0973                 sin(pi/2)  cos(pi/2) 0;<span class="keyword">...</span>
0974                 0           0      1];
0975             
0976             
0977             
0978             <span class="keyword">if</span> strcmpi(<span class="string">'line'</span>,obj.Speaker_Array_Type)
0979                 <span class="comment">% linear array test %%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0980                 <span class="comment">% Find P for a linear array</span>
0981                 phi_c = obj.Speaker_Array_Centre/180*pi;
0982                 C = O + obj.res*Rl*[cos(phi_c) -sin(phi_c) 0;<span class="keyword">...</span>
0983                     sin(phi_c)  cos(phi_c) 0;<span class="keyword">...</span>
0984                     0           0      1]*[1;0;0];
0985                 m1 = [cos(theta);sin(theta);0];
0986                 m2 = [cos(phi_c-pi/2);sin(phi_c-pi/2);0];
0987                 A=[m1 -m2];
0988                 b = [C-B];
0989                 w = pinv(A)*b;
0990                 P = B+w(1)*m1;
0991                 P_ = C+w(2)*m2;
0992                 <span class="keyword">if</span> ~all(round(P,10)==round(P_,10))
0993                     error(<span class="string">'Planewave does not intersect loudspeaker array.'</span>);
0994                 <span class="keyword">end</span>
0995                 
0996                 Pv = P-O;
0997                 PQv = Qv-Pv;
0998                 d = sqrt(sum((Q-P).^2))/obj.res;
0999                 Theta = abs(pi - abs(theta) - abs(phi_c) );
1000                 d_alias=[];
1001                 gam_found=[];
1002                 <span class="keyword">for</span> pm = [-1 1]
1003                     <span class="comment">% maximum allowable angle of grating lobe</span>
1004                     alph_=pm*asin((r1+r2)/d);
1005                     PAv=[cos(alph_) -sin(alph_) 0;<span class="keyword">...</span>
1006                         sin(alph_)  cos(alph_) 0;<span class="keyword">...</span>
1007                         0           0      1] * PQv;
1008                     
1009                     hold on; plot3([P(1) PAv(1)+P(1)],<span class="keyword">...</span>
1010                         [P(2) PAv(2)+P(2)],<span class="keyword">...</span>
1011                         [P(3) PAv(3)+P(3)],<span class="string">'--k'</span>); hold off;
1012                     
1013                     d_alias(end+1) = abs(  Pv.'   * (rotMat_90*PAv  )) <span class="keyword">...</span>
1014                         / sqrt(sum(( PAv ).^2)) / obj.res;
1015                     
1016                     
1017                     <span class="comment">% grating lobe angle</span>
1018                     <span class="comment">%                     gam_ = pm * asin(2*pi/obj.k_global/(obj.Speaker_Array_Length/(L-1)));</span>
1019                     PBv = Bv-Pv;
1020                     
1021                     <span class="comment">%tmp = asin(r1 / (sqrt(sum(( PBv ).^2)) / obj.res));</span>
1022                     <span class="comment">%                     tmp=0;</span>
1023                     gam_ = pm * ( asin(  2*pi*(L-1) / (k*arrLen) - sin(Theta) )  + Theta);
1024                     
1025                     gv=[cos(gam_) -sin(gam_) 0;<span class="keyword">...</span>
1026                         sin(gam_)  cos(gam_) 0;<span class="keyword">...</span>
1027                         0           0      1] * PBv;
1028                     
1029                     hold on; plot3([P(1) gv(1)+P(1)],<span class="keyword">...</span>
1030                         [P(2) gv(2)+P(2)],<span class="keyword">...</span>
1031                         [P(3) gv(3)+P(3)],<span class="string">':k'</span>); hold off;
1032                     
1033                     <span class="comment">%                     d_g(end+1) = abs(  Pv.'   * (rotMat_90*PAv  )) ...</span>
1034                     <span class="comment">%                         / sqrt(sum((PAv  ).^2)) / obj.res;</span>
1035                     gam_found(end+1) = atan2(norm(cross(PAv,PBv)), dot(PAv,PBv)); <span class="comment">% EQUIVALENT MATHEMATICALLY --&gt; acos(dot(v1, v2) / (norm(v1) * norm(v2)))</span>
1036                     
1037                 <span class="keyword">end</span>
1038                 
1039                 d_alias = max(d_alias);
1040                 gam_found = max(gam_found);
1041                 Alias_k =   2*pi*(L-1) / ((sin(gam_found - Theta) + sin(Theta))*arrLen)  ;
1042                 disp([<span class="string">'Alias Frequency: '</span> num2str(round(Alias_k/2/pi*obj.c,0)) <span class="string">'Hz'</span>]);
1043                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1044                 <a href="#_sub27" class="code" title="subfunction plotCircle(obj, Origin, Centre, Radius, plotArgs)">plotCircle</a>(obj, zeros(1,3), P/obj.res, <span class="keyword">...</span>
1045                     obj.Multizone_Soundfield.Bright_Zone.Radius_q, <span class="keyword">...</span>
1046                     {<span class="string">'--'</span>, <span class="string">'Color'</span>, [0 0 0], <span class="string">'LineWidth'</span>, LineWid});
1047                 
1048                 
1049                 
1050             <span class="keyword">elseif</span> strcmpi(<span class="string">'circle'</span>,obj.Speaker_Array_Type)
1051                 
1052                 alpha_ = pi +theta - asin(Br*sin(-theta + Bth)/Rl);
1053                 <span class="comment">% Find tangent</span>
1054                 P = O + Rl*obj.res * <span class="keyword">...</span>
1055                     [cos(alpha_) -sin(alpha_) 0;<span class="keyword">...</span>
1056                     sin(alpha_)  cos(alpha_) 0;<span class="keyword">...</span>
1057                     0           0       1]*[1;0;0];
1058                 Pv = P-O;
1059                 PQv = Qv-Pv;
1060                 d = sqrt(sum((Q-P).^2))/obj.res;
1061                 d_alias=[];
1062                 <span class="keyword">for</span> pm = [-1 1]
1063                     
1064                     alph_=pm*asin((r1+r2)/d);
1065                     
1066                     PAv=[cos(alph_) -sin(alph_) 0;<span class="keyword">...</span>
1067                         sin(alph_)  cos(alph_) 0;<span class="keyword">...</span>
1068                         0           0      1] * PQv;
1069                     hold on; plot3([P(1) PAv(1)+P(1)],<span class="keyword">...</span>
1070                         [P(2) PAv(2)+P(2)],<span class="keyword">...</span>
1071                         [P(3) PAv(3)+P(3)],<span class="string">'--k'</span>); hold off;
1072                     
1073                     <span class="comment">%                 P_r1 = rotMat_90*PAv / sqrt(sum(PAv.^2)) * r1*obj.res;</span>
1074                     <span class="comment">%                 P_1 = P + P_r1;</span>
1075                     <span class="comment">%                 P_2 = P_1 + PAv;</span>
1076                     <span class="comment">%                 hold on; plot3([P_1(1) P_2(1)],...</span>
1077                     <span class="comment">%                     [P_1(2) P_2(2)],...</span>
1078                     <span class="comment">%                     [P_1(3) P_2(3)]*0,'--k'); hold off;</span>
1079                     
1080                     <span class="comment">%             d_found  = sum((O - P_1) .* P_r1) / sqrt(sum(P_r1.^2)) / obj.res;</span>
1081                     <span class="comment">%             d_found2 = sum((O - P)   .* P_r1) / sqrt(sum(P_r1.^2)) / obj.res;</span>
1082                     d_alias(end+1) = abs(  Pv.'   * (rotMat_90*PAv  )) <span class="keyword">...</span>
1083                         / sqrt(sum((PAv  ).^2)) / obj.res;
1084                 <span class="keyword">end</span>
1085                 d_alias = max(d_alias);
1086                 
1087                 <a href="#_sub27" class="code" title="subfunction plotCircle(obj, Origin, Centre, Radius, plotArgs)">plotCircle</a>(obj, zeros(1,3), O/obj.res, d_alias, <span class="keyword">...</span>
1088                     {<span class="string">'--'</span>, <span class="string">'Color'</span>, [1 0 0], <span class="string">'LineWidth'</span>, LineWid});
1089                 
1090                 
1091                 <span class="comment">% Perpendicular distance from planewave to center</span>
1092                 PBv = Bv-Pv;
1093                 d_pb = abs(  Pv.'   * (rotMat_90*PBv  )) <span class="keyword">...</span>
1094                     / sqrt(sum((PBv  ).^2)) / obj.res;
1095                 
1096                 <span class="comment">% Maximum allowable aliasing frequency</span>
1097                 Alias_k = max( <span class="keyword">...</span>
1098                     [(2*pi*L - phi_L) / ((d_alias + d_pb)*phi_L), <span class="keyword">...</span>
1099                     (2*pi*L - phi_L) / (2*Rprime*phi_L)]);
1100                 disp([<span class="string">'Alias Frequency: '</span> num2str(round(Alias_k/2/pi*obj.c,0)) <span class="string">'Hz'</span>]);
1101                 
1102                 <span class="comment">% Current grating lobe edge</span>
1103                 Alias_R = (2*pi*L - phi_L) / (obj.k_global*phi_L) - d_pb;
1104                 <a href="#_sub27" class="code" title="subfunction plotCircle(obj, Origin, Centre, Radius, plotArgs)">plotCircle</a>(obj, zeros(1,3), O/obj.res, Alias_R, <span class="keyword">...</span>
1105                     {<span class="string">'--'</span>, <span class="string">'Color'</span>, [1 0 1], <span class="string">'LineWidth'</span>, LineWid});
1106                 
1107                 <span class="comment">%             M =  tan(pi/2 + asin( Rl*sin(Qth-alpha_) / d) - asin((r1+r2)/d)) ; % Gradient of aliasing tangent</span>
1108                 <span class="comment">%             x = 0:300;</span>
1109                 <span class="comment">%             % Maximum allowable aliasing lobe center</span>
1110                 <span class="comment">%             y = M*(x-Alias_Point(1))+Alias_Point(2);</span>
1111                 <span class="comment">%             hold on; plot3(x,y,x*0+maxZ,'-.','Color', [0 0 0], 'LineWidth', LineWid); hold off;</span>
1112                 <span class="comment">%             % Maximum allowable aliasing lobe edge</span>
1113                 <span class="comment">%             y = M*(x-Alias_Point(1) + sin(atan(M))*r1*obj.res)+Alias_Point(2) + cos(atan(M))*r1*obj.res;</span>
1114                 <span class="comment">%             hold on; plot3(x,y,x*0+maxZ,':','Color', [0 0 0], 'LineWidth', LineWid); hold off;</span>
1115                 <span class="comment">%</span>
1116                 <span class="comment">%             % Maximum allowable aliasing radius</span>
1117                 <span class="comment">%             Alias_R_found = abs( O(2) - M*O(1) ...</span>
1118                 <span class="comment">%                 + M*Alias_Point(1) - M*sin(atan(M))*r1*obj.res - Alias_Point(2) - cos(atan(M))*r1*obj.res ) ...</span>
1119                 <span class="comment">%                 / sqrt(1^2 + M^2) / obj.res;</span>
1120             <span class="keyword">end</span>
1121             
1122             <a href="#_sub27" class="code" title="subfunction plotCircle(obj, Origin, Centre, Radius, plotArgs)">plotCircle</a>(obj, zeros(1,3), P/obj.res, <span class="keyword">...</span>
1123                 obj.Multizone_Soundfield.Bright_Zone.Radius_q, <span class="keyword">...</span>
1124                 {<span class="string">'--'</span>, <span class="string">'Color'</span>, [0 0 0], <span class="string">'LineWidth'</span>, LineWid});
1125             
1126             <span class="comment">% Virtual point</span>
1127             arrow(P,BZ_Centre,arrowSpecs{:});
1128             
1129             
1130             
1131             
1132             
1133             
1134             
1135             
1136             
1137             
1138             
1139             
1140             hold off
1141         <span class="keyword">end</span>
1142         
1143         <a name="_sub29" href="#_subfunctions" class="code">function drawPlaneWaveArrow(obj,startPt,endPt,PWangle,arrowSpecs)</a>
1144             P = endPt-startPt;
1145             [~,el,r]=cart2sph(P(1),P(2),P(3));
1146             r_arr = r*2;
1147             [P(1),P(2),P(3)]=sph2cart(PWangle/180*pi,el,r_arr);
1148             [Pmid(1),Pmid(2),Pmid(3)]=sph2cart(PWangle/180*pi,el,r_arr/2);
1149             endPt = P + startPt;
1150             arrow(startPt,endPt,arrowSpecs{:});
1151             <span class="comment">%draw three perpendicular straight lines</span>
1152             noLines = 4;
1153             lineLength = 7;
1154             sepDist = 10;
1155             x = repmat(linspace(-1,1,noLines),3,1)*sepDist;
1156             y = repmat([-1;0;1],1,noLines)*lineLength;
1157             [az,~,r]=cart2sph(x,y,zeros(size(x)));
1158             [Pts(:,:,1),Pts(:,:,2),Pts(:,:,3)] = sph2cart(az+PWangle/180*pi,ones(size(az))*el,r);
1159             Pts = Pts + permute(repmat(Pmid'+startPt,1,noLines,3),[3 2 1]);
1160             hold on;
1161             plot3(gca, Pts(:,:,1),Pts(:,:,2),Pts(:,:,3), <span class="string">'Color'</span>, [0 0 0], <span class="string">'LineWidth'</span>, 2);
1162             hold off;
1163         <span class="keyword">end</span>
1164         
1165         <a name="_sub30" href="#_subfunctions" class="code">function addText2Arrow(obj,txt,startPt,endPt,fontsz,DistAway,AngAway)</a>
1166             P=endPt-startPt;
1167             [az,el,r] = cart2sph(P(1),P(2),P(3));
1168             [x,y,z] = sph2cart(az,el,r/2);
1169             [x2,y2,z2] = sph2cart(az+pi/2-AngAway/180*pi,0,DistAway);
1170             P=[x;y;z]+[x2;y2;z2]+startPt;
1171             
1172             text(P(1),P(2),P(3), <span class="keyword">...</span>
1173                 [<span class="string">'\fontsize{'</span> num2str(fontsz) <span class="string">'} \fontname{times}'</span> txt], <span class="keyword">...</span>
1174                 <span class="string">'interpreter'</span>,<span class="string">'tex'</span>, <span class="keyword">...</span>
1175                 <span class="string">'HorizontalAlignment'</span>,<span class="string">'center'</span>)
1176         <span class="keyword">end</span>
1177         
1178         <a name="_sub31" href="#_subfunctions" class="code">function drawAngle(obj,centre,startAng,endAng,Radius,LineWid,Elevation)</a>
1179             az = startAng : ((endAng&gt;startAng)*2-1)*pi/obj.res : endAng;
1180             [x,y,z]=sph2cart(az,zeros(size(az))*Elevation,Radius);
1181             P = [x;y;z] + repmat(centre,1,length(az));
1182             hold on;
1183             plot3(gca, P(1,:), P(2,:), P(3,:), <span class="string">'Color'</span>, [0 0 0], <span class="string">'LineWidth'</span>, LineWid);
1184             hold off;
1185         <span class="keyword">end</span>
1186         
1187         <a name="_sub32" href="#_subfunctions" class="code">function addText2Angle(obj,txt,centre,startAng,endAng,fontsz,DistAway,Elevation)</a>
1188             az = median( startAng : ((endAng&gt;startAng)*2-1)*pi/obj.res : endAng );
1189             [x,y,z]=sph2cart(az,Elevation,DistAway);
1190             P = [x;y;z] + centre;
1191             
1192             text(P(1),P(2),P(3), <span class="keyword">...</span>
1193                 [<span class="string">'\fontsize{'</span> num2str(fontsz) <span class="string">'} \fontname{times}'</span> txt], <span class="keyword">...</span>
1194                 <span class="string">'interpreter'</span>,<span class="string">'tex'</span>, <span class="keyword">...</span>
1195                 <span class="string">'HorizontalAlignment'</span>,<span class="string">'center'</span>)
1196         <span class="keyword">end</span>
1197         
1198         <a name="_sub33" href="#_subfunctions" class="code">function h = sourcePlots(obj, field, realistic, details)</a>
1199             <span class="keyword">if</span> nargin &lt; 4; details = []; <span class="keyword">end</span>
1200             <span class="keyword">if</span> nargin &lt; 3; realistic = false; <span class="keyword">end</span>
1201             <span class="keyword">if</span> nargin &lt; 2; field = obj.Soundfield_reproduced; <span class="keyword">end</span>;
1202             
1203             <span class="keyword">if</span> realistic
1204                 maxZ = 0;
1205             <span class="keyword">else</span>
1206                 maxZ = max(real(field(:)));
1207             <span class="keyword">end</span>
1208             <span class="comment">%O = length(obj.Soundfield_reproduced) / 2; %Set the centre of the zone for indexing</span>
1209             O = [flip(size(field))/2 0] + [flip(obj.Origin)*obj.res 0];
1210             
1211             hold on;
1212             
1213             [sl_x, sl_y] = pol2cart(obj.Loudspeaker_Locations(:,1), (obj.Loudspeaker_Locations(:,2) * obj.res));
1214             
1215             <span class="keyword">if</span> strcmpi( obj.Multizone_Soundfield.Bright_Zone.SourceType, <span class="string">'ps'</span>)
1216                 ps_d = obj.Multizone_Soundfield.Bright_Zone.SourceOrigin.Distance;
1217                 ps_a = obj.Multizone_Soundfield.Bright_Zone.SourceOrigin.Angle/180*pi;
1218                 [ps_x, ps_y] = pol2cart(ps_a, (ps_d * obj.res)-1);
1219             <span class="keyword">else</span>
1220                 ps_x = nan;
1221                 ps_y = nan;
1222             <span class="keyword">end</span>
1223             
1224             <span class="keyword">if</span> realistic
1225                 L = obj.Loudspeaker_Count;
1226                 widL = repmat(obj.Loudspeaker_Dimensions(1) * obj.res, L, 1 ); <span class="comment">%metres</span>
1227                 depL = repmat(obj.Loudspeaker_Dimensions(2) * obj.res, L, 1 ); <span class="comment">%metres</span>
1228                 higL = repmat(obj.Loudspeaker_Dimensions(3) * obj.res, L, 1 ); <span class="comment">%metres</span>
1229                 widL_half = widL / 2; <span class="comment">%metres</span>
1230                 depL_half = depL / 2; <span class="comment">%metres</span>
1231                 higL_half = higL / 2; <span class="comment">%metres</span>
1232                 
1233                 thL = zeros(L,4);
1234                 xL = thL;
1235                 yL = thL;
1236                 radL = zeros(L,1);
1237                 
1238                 <span class="keyword">if</span> strcmp(obj.Speaker_Array_Type, <span class="string">'circle'</span>)
1239                     thL = repmat(obj.Loudspeaker_Locations(:,1),1,4);
1240                     radL = repmat(obj.Radius * obj.res,L,1) - 1;
1241                     [xL, yL] = pol2cart(obj.Loudspeaker_Locations(:,1), <span class="keyword">...</span>
1242                         obj.Loudspeaker_Locations(:,2) * obj.res - 1);
1243                     xL = repmat(xL,1,4);
1244                     yL = repmat(yL,1,4);
1245                 <span class="keyword">elseif</span> ~isempty(strfind(obj.Speaker_Array_Type, <span class="string">'line'</span>))
1246                     thL = repmat(obj.Speaker_Array_Centre,L,4)/180*pi;
1247                     [xL, yL] = pol2cart(obj.Loudspeaker_Locations(:,1), <span class="keyword">...</span>
1248                         obj.Loudspeaker_Locations(:,2) * obj.res - 1);
1249                     xL = repmat(xL,1,4);
1250                     yL = repmat(yL,1,4);
1251                 <span class="keyword">end</span>
1252                 
1253                 
1254                 <span class="keyword">for</span> i = 1:obj.Loudspeaker_Count
1255                     <span class="comment">% Create Cube</span>
1256                     px_=[-1,1,1,-1;-1,1,1,-1];
1257                     py_=[-1,-1,1,1;-1,-1,1,1];
1258                     pz_=[-1,-1,-1,-1;1,1,1,1];
1259                     <span class="comment">%Size to Rect Prism</span>
1260                     px = ([px_;py_;pz_]'+1) .* widL_half(i); <span class="comment">%plus one shifts cube so origin is on a face</span>
1261                     py = ([py_;pz_;px_]'+0) .* depL_half(i);
1262                     pz = ([pz_;px_;py_]'+0) .* higL_half(i);
1263                     <span class="comment">%Rotate Rect Prism</span>
1264                     [az, el, r] = cart2sph(px, py, pz);
1265                     [px, py, pz] = sph2cart(az + thL(i,1), el + 0, r + 0);
1266                     <span class="comment">%Shift Rect Prism</span>
1267                     px = px + O(1) + xL(i,1);
1268                     py = py + O(2) + yL(i,1);
1269                     <span class="comment">%pz = pz + O + zL(i,1);</span>
1270                     
1271                     h.box(i) = patch(px,py,pz,[0.5 0.5 0.5]);
1272                     
1273                 <span class="keyword">end</span>
1274             <span class="keyword">end</span>
1275             [slx,sly,slz] = sphere(5);
1276             <span class="keyword">if</span> isempty(details)
1277                 sphereRad = 2; <span class="comment">%centimetres</span>
1278             <span class="keyword">else</span>
1279                 sphereRad = details.sphereRad;
1280             <span class="keyword">end</span>
1281             sphereRad = sphereRad/100*obj.res;
1282             <span class="keyword">for</span> i = 1:obj.Loudspeaker_Count
1283                 h.sphere(i) = surf( <span class="keyword">...</span>
1284                     slx*sphereRad + sl_x(i) + O(1), <span class="keyword">...</span>
1285                     sly*sphereRad + sl_y(i) + O(2), <span class="keyword">...</span>
1286                     slz*sphereRad + ones(size(sl_x(i)))*maxZ, <span class="keyword">...</span>
1287                     repmat(0.5,[size(slx),3]), <span class="keyword">...</span>
1288                     <span class="string">'linestyle'</span>,<span class="string">':'</span>);
1289             <span class="keyword">end</span>
1290             <span class="comment">%scatter3(sl_x + O, sl_y + O, ones(length(sl_x),1)*maxZ, 100, 'MarkerEdgeColor', [0 0 0],'MarkerFaceColor', [1 1 1], 'LineWidth', 3);</span>
1291             
1292             <span class="comment">% Plot virtual source</span>
1293             <span class="keyword">if</span> strcmpi( obj.Multizone_Soundfield.Bright_Zone.SourceType, <span class="string">'ps'</span>)
1294                 BZ_O =[obj.Multizone_Soundfield.Bright_Zone.Origin_q.X, <span class="keyword">...</span>
1295                     obj.Multizone_Soundfield.Bright_Zone.Origin_q.Y]*obj.res;
1296                 h.sphereVSrc = surf( <span class="keyword">...</span>
1297                     slx*sphereRad + ps_x + O(1) + BZ_O(1), <span class="keyword">...</span>
1298                     sly*sphereRad + ps_y + O(2) + BZ_O(2), <span class="keyword">...</span>
1299                     slz*sphereRad + ones(size(ps_x))*maxZ, <span class="keyword">...</span>
1300                     repmat(0.5,[size(slx),3]), <span class="keyword">...</span>
1301                     <span class="string">'linestyle'</span>,<span class="string">'none'</span>);
1302                 h.sphereVSrc.CData = permute(repmat([0 0.2 1].',[1,size(slx)]),[2 3 1]);
1303             <span class="keyword">end</span>
1304             [c_x, c_y] = pol2cart(obj.Speaker_Array_Centre/180*pi, (obj.Radius * obj.res));
1305             
1306             h.sphereVSrc = surf( <span class="keyword">...</span>
1307                 slx*sphereRad + c_x + O(1), <span class="keyword">...</span>
1308                 sly*sphereRad + c_y + O(2), <span class="keyword">...</span>
1309                 slz*sphereRad + ones(size(ps_x))*maxZ, <span class="keyword">...</span>
1310                 repmat(0.5,[size(slx),3]), <span class="keyword">...</span>
1311                 <span class="string">'linestyle'</span>,<span class="string">'none'</span>);
1312             h.sphereVSrc.CData = permute(repmat([1 0 0].',[1,size(slx)]),[2 3 1]);
1313             
1314             
1315             hold off;
1316         <span class="keyword">end</span>
1317         
1318     <span class="keyword">end</span>
1319     
1320 <span class="keyword">end</span>
1321</pre></div>
<hr><address>Generated on Sun 09-Jul-2017 20:35:18 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>